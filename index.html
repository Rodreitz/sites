<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Arttes da Bel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#F3E4D7',
                        'brand-text': '#786D4E',
                        'brand-olive': '#A5A184',
                        'brand-pink': '#F39B92',
                        'brand-primary': '#DA7E55',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Montserrat', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-family: 'Inter', sans-serif; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #DA7E55; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .input-prefix { position: absolute; left: 0; top: 0; height: 100%; display: flex; align-items: center; padding-left: 0.75rem; color: #6b7280; }
        .input-group input { padding-left: 2.5rem; }
        .saved-status { transition: opacity 0.5s ease-in-out, color 0.3s; }
        #sidebar { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-brand-bg/50 text-brand-text">

    <!-- Seção de Login -->
    <div id="loginView">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md">
                <header class="text-center mb-8">
                    <img src="https://raw.githubusercontent.com/Rodreitz/sites/adab42e1b226613b95b484f00337e8c1903b186b/LOGO%20COM%20NOME%20transparente.png" alt="Logo Arttes da Bel" class="mx-auto w-48 h-auto mb-4">
                    <h1 class="font-display text-3xl text-brand-primary">Área Exclusiva</h1>
                    <p class="text-brand-text">Acesse a calculadora e outras ferramentas.</p>
                </header>
                <main class="bg-white p-8 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <form id="authForm" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-brand-text">Email</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-brand-text">Senha</label>
                            <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                        </div>
                        <div id="errorMessage" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                        <div class="flex flex-col gap-4">
                            <button type="submit" id="loginButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-white bg-brand-primary hover:bg-brand-text focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary font-semibold">Entrar</button>
                            <button type="submit" id="registerButton" class="w-full flex justify-center py-2 px-4 border border-brand-olive text-brand-text bg-transparent hover:bg-brand-bg rounded-md shadow-sm font-semibold">Cadastrar</button>
                        </div>
                    </form>
                </main>
                <footer class="text-center mt-8 text-sm text-gray-500">
                    <p>&copy; 2024 - Arttes da Bel</p>
                </footer>
            </div>
        </div>
    </div>

    <!-- Seção do Aplicativo (Layout Principal) -->
    <div id="appView" class="hidden">
        <div class="relative min-h-screen md:flex">
            <!-- Overlay para fechar sidebar no mobile -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            
            <!-- Barra Lateral Retrátil -->
            <aside id="sidebar" class="bg-brand-bg text-brand-text w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30">
                <a href="#dashboard" class="nav-link text-white text-xl flex items-center px-4">
                    <img src="https://raw.githubusercontent.com/Rodreitz/sites/adab42e1b226613b95b484f00337e8c1903b186b/LOGO%20COM%20NOME%20transparente.png" alt="Logo Arttes da Bel" class="w-32 h-auto mx-auto">
                </a>
                <nav>
                    <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white bg-brand-primary/20">Página Inicial</a>
                    <a href="#calculator" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white">Calculadora F.L.O.R.A.</a>
                    <a href="#my-pieces" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white opacity-50 cursor-not-allowed">Minhas Peças Salvas</a>
                    <a href="#management" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white">Gestão de Encomendas</a>
                    <a href="#stock" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-brand-primary hover:text-white">Controle de Estoque</a>
                </nav>
            </aside>
            
            <!-- Conteúdo Principal -->
            <div class="flex-1 flex flex-col">
                <header class="flex justify-between items-center p-4 bg-white shadow-md">
                    <button id="sidebar-toggle" class="text-brand-text focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <button id="logoutButton" class="text-sm bg-brand-pink text-white font-semibold py-1 px-3 rounded-full hover:bg-brand-primary transition-colors">Sair</button>
                </header>
                
                <div id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <!-- Página Inicial / Dashboard -->
                    <div id="dashboardView">
                        <h1 class="font-display text-3xl text-brand-text mb-2">Bem-vinda, Artesã!</h1>
                        <p id="welcomeMessage" class="text-lg text-gray-600 mb-8">Aqui você encontra as ferramentas para florescer seu ateliê.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <a href="#calculator" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20 hover:shadow-xl transition-shadow">
                                <h2 class="font-display text-xl text-brand-primary">Calculadora F.L.O.R.A.</h2>
                                <p class="mt-2 text-sm">Calcule o preço justo de suas peças com confiança e garanta seu lucro.</p>
                            </a>
                            <a href="#my-pieces" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20 opacity-50 cursor-not-allowed">
                                <h2 class="font-display text-xl text-brand-text">Minhas Peças Salvas</h2>
                                <p class="mt-2 text-sm">Acesse seu catálogo de produtos com preços já calculados. (Em breve)</p>
                            </a>
                            <a href="#management" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <h2 class="font-display text-xl text-brand-text">Gestão de Encomendas</h2>
                                <p class="mt-2 text-sm">Organize seus pedidos e acompanhe o status de cada um. (Em breve)</p>
                            </a>
                            <a href="#stock" class="nav-link bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <h2 class="font-display text-xl text-brand-text">Controle de Estoque</h2>
                                <p class="mt-2 text-sm">Saiba exatamente quais materiais você tem e quando precisa comprar mais. (Em breve)</p>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Calculadora -->
                    <div id="calculatorView" class="hidden">
                        <main class="space-y-8">
                            <div id="restoreBanner" class="hidden bg-brand-olive/20 p-4 rounded-lg flex items-center justify-between">
                                <p class="text-brand-text font-medium">Encontramos um cálculo não salvo. Deseja restaurá-lo?</p>
                                <div>
                                    <button id="restoreYes" class="bg-brand-primary text-white px-3 py-1 rounded-md text-sm font-semibold mr-2">Sim</button>
                                    <button id="restoreNo" class="bg-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm">Não</button>
                                </div>
                            </div>
                            <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="font-display text-2xl text-brand-text flex items-center">
                                        <span class="text-3xl mr-3">1.</span> Dados do Seu Ateliê 
                                    </h2>
                                    <span id="atelierDataStatus" class="saved-status text-sm font-medium text-brand-olive opacity-0 flex items-center gap-2">
                                        <svg id="statusIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                        <span id="statusText">Salvo!</span>
                                    </span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div>
                                        <label for="hourlyRate" class="block text-sm font-medium text-brand-text">Valor da sua Hora de Trabalho</label>
                                        <p class="text-xs text-gray-500 mt-1">Quanto você quer ganhar por hora de costura?</p>
                                        <div class="relative mt-2 input-group">
                                            <span class="input-prefix">R$</span>
                                            <input type="text" inputmode="decimal" id="hourlyRate" class="atelier-input numeric-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="20,00">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="fixedCosts" class="block text-sm font-medium text-brand-text">Custos Fixos Mensais</label>
                                        <p class="text-xs text-gray-500 mt-1">Luz, internet, aluguel, etc.</p>
                                        <div class="relative mt-2 input-group">
                                             <span class="input-prefix">R$</span>
                                            <input type="text" inputmode="decimal" id="fixedCosts" class="atelier-input numeric-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="300,00">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="hoursWorked" class="block text-sm font-medium text-brand-text">Horas Trabalhadas por Mês</label>
                                        <p class="text-xs text-gray-500 mt-1">Quantas horas você se dedica à produção.</p>
                                        <input type="text" inputmode="decimal" id="hoursWorked" class="atelier-input numeric-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="80">
                                    </div>
                                </div>
                                 <div class="mt-4 bg-brand-bg p-3 rounded-lg text-center">
                                    <p class="text-sm text-brand-text">Custo Fixo por Hora do Ateliê:</p>
                                    <p id="fixedCostPerHour" class="text-lg font-bold text-brand-text">R$ 0,00</p>
                                </div>
                            </section>
                            <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                                    <span class="text-3xl mr-3">2.</span> Custos da Peça
                                </h2>
                                <div>
                                    <label for="pieceName" class="block text-sm font-medium text-brand-text">Nome da Peça</label>
                                    <p class="text-xs text-gray-500 mt-1">Dê um nome para este cálculo (Ex: Jogo Americano Floral).</p>
                                    <input type="text" id="pieceName" class="piece-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="Jogo Americano Floral">
                                </div>
                                <h3 class="font-display text-lg font-semibold text-brand-text mt-6 mb-2">A. Custo dos Materiais</h3>
                                <div id="materialsContainer" class="space-y-4"></div>
                                <button id="addMaterial" class="mt-4 text-sm text-brand-primary hover:text-brand-text font-medium">+ Adicionar Material</button>
                                <div class="mt-4 text-right bg-gray-50 p-2 rounded-md">
                                    <span class="font-medium text-gray-600">Subtotal de Materiais:</span>
                                    <span id="materialsSubtotal" class="font-bold text-gray-800 ml-2">R$ 0,00</span>
                                </div>
                                <h3 class="font-display text-lg font-semibold text-brand-text mt-6 mb-2">B. Custo da Mão de Obra</h3>
                                <div id="tasksContainer" class="space-y-4"></div>
                                <button id="addTask" class="mt-4 text-sm text-brand-primary hover:text-brand-text font-medium">+ Adicionar Tarefa</button>
                                <div class="mt-4 text-right bg-gray-50 p-2 rounded-md">
                                    <span class="font-medium text-gray-600">Tempo Total de Produção:</span>
                                    <span id="totalTime" class="font-bold text-gray-800 ml-2">0 min</span>
                                </div>
                            </section>
                            <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                                   <span class="text-3xl mr-3">3.</span> Resumo dos Custos
                                </h2>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                        <span class="font-medium text-gray-600">Custo Total de Materiais</span>
                                        <span id="summaryMaterials" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                        <span class="font-medium text-gray-600">Custo Total da Mão de Obra</span>
                                        <span id="summaryLabor" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                        <span class="font-medium text-gray-600">Custo Fixo da Peça</span>
                                        <span id="summaryFixed" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-brand-olive/20 p-4 rounded-lg mt-2">
                                        <span class="font-bold text-brand-text text-lg">CUSTO DE PRODUÇÃO DA PEÇA</span>
                                        <span id="productionCost" class="font-extrabold text-2xl text-brand-text">R$ 0,00</span>
                                    </div>
                                </div>
                            </section>
                            <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                                    <span class="text-3xl mr-3">4.</span> Preço Final de Venda
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                                    <div>
                                        <label for="profitMargin" class="block text-sm font-medium text-brand-text">Sua Margem de Lucro (%)</label>
                                        <p class="text-xs text-gray-500 mt-1">Quanto você quer lucrar sobre o custo. 100% é um bom começo.</p>
                                        <input type="text" inputmode="decimal" id="profitMargin" class="numeric-input piece-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="100">
                                    </div>
                                    <div>
                                        <label for="fees" class="block text-sm font-medium text-brand-text">Taxas (%)</label>
                                        <p class="text-xs text-gray-500 mt-1">Taxas de cartão, marketplace, etc.</p>
                                        <input type="text" inputmode="decimal" id="fees" class="numeric-input piece-input w-full mt-2 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="5">
                                    </div>
                                </div>
                                <div class="mt-6 space-y-4">
                                    <div class="bg-brand-primary text-white p-6 rounded-2xl text-center">
                                        <p class="font-semibold text-lg opacity-90">PREÇO DE VENDA FINAL (SUGERIDO)</p>
                                        <p id="finalPrice" class="font-extrabold text-5xl tracking-tight">R$ 0,00</p>
                                    </div>
                                    <div class="bg-brand-pink/30 border-l-4 border-brand-pink text-brand-text p-4 rounded-r-lg">
                                        <div class="flex justify-between items-center">
                                            <p class="font-bold text-lg">LUCRO LÍQUIDO POR PEÇA:</p>
                                            <p id="netProfit" class="font-bold text-2xl">R$ 0,00</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                                <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                                   <span class="text-3xl mr-3">5.</span> Assistente de Vendas IA ✨
                                </h2>
                                <p class="text-gray-600 mb-6">Use a inteligência artificial para criar textos de venda e ter ideias para divulgar seu produto. Preencha os dados da peça acima e clique nos botões abaixo.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 class="font-display text-lg font-semibold text-brand-text">Descrição Mágica para Redes Sociais</h3>
                                        <button id="generateDescription" class="w-full mt-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                            Gerar Descrição
                                        </button>
                                        <div id="descriptionLoader" class="loader hidden"></div>
                                        <div id="descriptionResult" class="mt-4 p-4 bg-gray-50 rounded-md text-gray-700 whitespace-pre-wrap min-h-[100px] border">
                                            ✨ Clique em 'Gerar Descrição' e veja a mágica acontecer! Criaremos um texto de venda encantador para sua peça.
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-display text-lg font-semibold text-brand-text">Ideias Criativas para Vender Mais</h3>
                                        <button id="generateSuggestions" class="w-full mt-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center">
                                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4.95 16.464l.707-.707a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414zm-3.536-2.121a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1z" clip-rule="evenodd" /></svg>
                                            Gerar Ideias
                                        </button>
                                        <div id="suggestionsLoader" class="loader hidden"></div>
                                        <div id="suggestionsResult" class="mt-4 p-4 bg-gray-50 rounded-md text-gray-700 whitespace-pre-wrap min-h-[100px] border">
                                            💡 Sem inspiração? Clique em 'Gerar Ideias' para descobrir novas formas de divulgar e vender seu produto!
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </main>
                    </div>
                    
                    <!-- Telas "Em Breve" -->
                    <div id="myPiecesView" class="hidden text-center">
                        <h1 class="font-display text-3xl text-brand-text mb-4">Minhas Peças Salvas</h1>
                        <p class="text-lg text-gray-600">Esta funcionalidade está sendo preparada com muito carinho e estará disponível em breve!</p>
                    </div>
                    <div id="managementView" class="hidden text-center">
                        <h1 class="font-display text-3xl text-brand-text mb-4">Gestão de Encomendas</h1>
                        <p class="text-lg text-gray-600">Esta funcionalidade está sendo preparada com muito carinho e estará disponível em breve!</p>
                    </div>
                    <div id="stockView" class="hidden text-center">
                        <h1 class="font-display text-3xl text-brand-text mb-4">Controle de Estoque</h1>
                        <p class="text-lg text-gray-600">Esta funcionalidade está sendo preparada com muito carinho e estará disponível em breve!</p>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Boas-vindas -->
    <div id="welcomeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-lg w-full text-center shadow-xl">
            <h2 class="font-display text-2xl text-brand-primary mb-4">Seja bem-vinda, artesã!</h2>
            <p class="text-brand-text mb-6">Ficamos felizes em te ver por aqui! Para começar a usar sua calculadora, o primeiro passo é configurar os dados base do seu ateliê. É rapidinho e você só precisa fazer isso uma vez!</p>
            <button id="closeWelcomeModal" class="w-full bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors">Vamos lá!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        async function getFirebaseConfig() {
            try {
                const response = await fetch('/api/get-firebase-config');
                if (!response.ok) throw new Error('Falha ao buscar configuração do Firebase.');
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function main() {
            const loginView = document.getElementById('loginView');
            const appView = document.getElementById('appView');
            const errorMessageDiv = document.getElementById('errorMessage');

            const firebaseConfig = await getFirebaseConfig();
            if (!firebaseConfig) {
                errorMessageDiv.textContent = 'Erro de configuração. Não foi possível carregar a página.';
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const loginButton = document.getElementById('loginButton');
            const registerButton = document.getElementById('registerButton');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const logoutButton = document.getElementById('logoutButton');
            
            let currentUser = null;
            let atelierDataRef = null;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    atelierDataRef = doc(db, "atelierData", currentUser.uid);
                    loginView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    loadUserData();
                } else {
                    currentUser = null;
                    atelierDataRef = null;
                    loginView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });

            function showAuthError(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.classList.remove('hidden');
            }

            loginButton.addEventListener('click', (e) => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                    .catch((error) => {
                        showAuthError(error.code === 'auth/invalid-credential' ? "Email ou senha inválidos." : "Ocorreu um erro ao entrar.");
                    });
            });

            registerButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (passwordInput.value.length < 6) {
                    showAuthError("A senha deve ter pelo menos 6 caracteres."); return;
                }
                createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                    .then(() => alert("Cadastro realizado com sucesso!"))
                    .catch((error) => {
                        showAuthError(error.code === 'auth/email-already-in-use' ? "Este email já está cadastrado." : "Ocorreu um erro ao cadastrar.");
                    });
            });
            
            logoutButton.addEventListener('click', () => {
                signOut(auth).catch((error) => console.error("Erro ao sair:", error));
            });

            const atelierInputs = document.querySelectorAll('.atelier-input');
            const statusIndicator = document.getElementById('atelierDataStatus');
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            let saveTimeout = null;

            async function loadUserData() {
                if (!atelierDataRef) return;
                try {
                    const docSnap = await getDoc(atelierDataRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('hourlyRate').value = data.hourlyRate || '';
                        document.getElementById('fixedCosts').value = data.fixedCosts || '';
                        document.getElementById('hoursWorked').value = data.hoursWorked || '';
                        document.getElementById('welcomeMessage').textContent = `Bem-vinda, ${currentUser.email.split('@')[0]}!`;
                        if (!data.hasLoggedInBefore) {
                            document.getElementById('welcomeModal').classList.remove('hidden');
                        }
                        checkAndRestorePiece();
                    } else {
                        document.getElementById('welcomeModal').classList.remove('hidden');
                    }
                    calculateAll();
                } catch (error) {
                    console.error("Erro ao carregar dados do ateliê:", error);
                }
            }

            function saveAtelierData(isFirstSave = false) {
                if (!atelierDataRef) return;
                const data = {
                    hourlyRate: document.getElementById('hourlyRate').value,
                    fixedCosts: document.getElementById('fixedCosts').value,
                    hoursWorked: document.getElementById('hoursWorked').value,
                };
                if (isFirstSave) {
                    data.hasLoggedInBefore = true;
                }
                setDoc(atelierDataRef, data, { merge: true })
                    .then(() => {
                        statusText.textContent = 'Salvo na nuvem!';
                        statusIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>`;
                        statusIndicator.classList.remove('text-yellow-600');
                        statusIndicator.classList.add('text-brand-olive');
                        statusIndicator.style.opacity = '1';
                        setTimeout(() => { statusIndicator.style.opacity = '0'; }, 2000);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar dados:", error);
                        statusText.textContent = 'Erro ao salvar!';
                        statusIndicator.classList.add('text-red-500');
                        statusIndicator.style.opacity = '1';
                    });
            }
            
            atelierInputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    statusText.textContent = 'Salvando...';
                    statusIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
                    statusIndicator.classList.remove('text-brand-olive');
                    statusIndicator.classList.add('text-yellow-600');
                    statusIndicator.style.opacity = '1';
                    saveTimeout = setTimeout(() => saveAtelierData(), 1500);
                });
            });

            const welcomeModal = document.getElementById('welcomeModal');
            const closeWelcomeModalBtn = document.getElementById('closeWelcomeModal');
            closeWelcomeModalBtn.addEventListener('click', () => {
                welcomeModal.classList.add('hidden');
                saveAtelierData(true);
            });

            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            const callAIAssistant = async (dataPayload) => {
                const proxyUrl = '/api/gemini-proxy';
                try {
                    const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataPayload) });
                    if (!response.ok) throw new Error(`Erro: ${response.statusText}`);
                    const result = await response.json();
                    return result.text;
                } catch (error) {
                    console.error("Erro no assistente IA:", error);
                    return "Desculpe, não foi possível gerar a resposta no momento.";
                }
            };
            
            function setupCalculator() {
                const materialsContainer = document.getElementById('materialsContainer');
                const tasksContainer = document.getElementById('tasksContainer');
                const addMaterialBtn = document.getElementById('addMaterial');
                const addTaskBtn = document.getElementById('addTask');

                const addMaterialRow = (name = '', price = '', quantity = '') => {
                    const div = document.createElement('div');
                    div.classList.add('relative', 'p-4', 'border', 'rounded-lg', 'space-y-2', 'pt-8', 'material-row');
                    div.innerHTML = `
                        <button class="remove-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        <div class="w-full"> <label class="text-sm font-medium text-brand-text">Nome do Material</label> <p class="text-xs text-gray-500 mt-1">Ex: Tecido Tricoline, Linha, Zíper.</p> <input type="text" value="${name}" class="material-name piece-input w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div> <label class="text-sm font-medium text-brand-text">Preço</label> <p class="text-xs text-gray-500 mt-1">Preço do item comprado (metro, unidade).</p> <div class="relative mt-1 input-group"> <span class="input-prefix text-sm">R$</span> <input type="text" value="${price}" inputmode="decimal" placeholder="30,00" class="numeric-input piece-input material-price w-full p-2 border border-gray-200 rounded-md text-sm"> </div> </div>
                            <div> <label class="text-sm font-medium text-brand-text">Qtd. Usada</label> <p class="text-xs text-gray-500 mt-1">Fração usada (ex: 0.45 para 45cm).</p> <input type="text" value="${quantity}" inputmode="decimal" placeholder="0,45" class="numeric-input piece-input material-quantity w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        </div>`;
                    materialsContainer.appendChild(div);
                    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); calculateAll(); savePieceToLocalStorage(); });
                };

                const addTaskRow = (name = '', time = '') => {
                    const div = document.createElement('div');
                    div.classList.add('relative', 'p-4', 'border', 'rounded-lg', 'space-y-2', 'pt-8', 'task-row');
                    div.innerHTML = `
                        <button class="remove-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        <div class="w-full"> <label class="text-sm font-medium text-brand-text">Nome da Tarefa</label> <p class="text-xs text-gray-500 mt-1">Ex: Cortar, Costurar, Acabamento.</p> <input type="text" value="${name}" class="task-name piece-input w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        <div> <label class="text-sm font-medium text-brand-text">Tempo (minutos)</label> <p class="text-xs text-gray-500 mt-1">Quanto tempo levou nesta tarefa.</p> <input type="text" value="${time}" inputmode="decimal" placeholder="40" class="numeric-input piece-input task-time w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>`;
                    tasksContainer.appendChild(div);
                    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); calculateAll(); savePieceToLocalStorage(); });
                };

                addMaterialBtn.addEventListener('click', () => addMaterialRow());
                addTaskBtn.addEventListener('click', () => addTaskRow());

                const calculateAll = () => {
                    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value.replace(',', '.')) || 0;
                    const fixedCosts = parseFloat(document.getElementById('fixedCosts').value.replace(',', '.')) || 0;
                    const hoursWorked = parseFloat(document.getElementById('hoursWorked').value.replace(',', '.')) || 0;
                    const fixedCostPerHour = hoursWorked > 0 ? fixedCosts / hoursWorked : 0;
                    document.getElementById('fixedCostPerHour').textContent = formatCurrency(fixedCostPerHour);

                    let materialsSubtotal = 0;
                    document.querySelectorAll('.material-row').forEach(row => {
                        const price = parseFloat(row.querySelector('.material-price').value.replace(',', '.')) || 0;
                        const quantity = parseFloat(row.querySelector('.material-quantity').value.replace(',', '.')) || 0;
                        materialsSubtotal += price * quantity;
                    });
                    document.getElementById('materialsSubtotal').textContent = formatCurrency(materialsSubtotal);

                    let totalMinutes = 0;
                    document.querySelectorAll('.task-row').forEach(row => {
                        totalMinutes += parseFloat(row.querySelector('.task-time').value.replace(',', '.')) || 0;
                    });
                    const totalHours = totalMinutes / 60;
                    document.getElementById('totalTime').textContent = `${Math.round(totalMinutes)} min`;
                    const laborCost = totalHours * hourlyRate;

                    const pieceFixedCost = totalHours * fixedCostPerHour;
                    const productionCost = materialsSubtotal + laborCost + pieceFixedCost;
                    document.getElementById('summaryMaterials').textContent = formatCurrency(materialsSubtotal);
                    document.getElementById('summaryLabor').textContent = formatCurrency(laborCost);
                    document.getElementById('summaryFixed').textContent = formatCurrency(pieceFixedCost);
                    document.getElementById('productionCost').textContent = formatCurrency(productionCost);

                    const profitMargin = parseFloat(document.getElementById('profitMargin').value.replace(',', '.')) || 0;
                    const fees = parseFloat(document.getElementById('fees').value.replace(',', '.')) || 0;
                    
                    const basePrice = productionCost * (1 + profitMargin / 100);
                    const finalPrice = fees > 0 && fees < 100 ? basePrice / (1 - fees / 100) : basePrice;
                    const feeValue = finalPrice * (fees / 100);
                    const netProfit = finalPrice - feeValue - productionCost;

                    document.getElementById('finalPrice').textContent = formatCurrency(finalPrice);
                    document.getElementById('netProfit').textContent = formatCurrency(netProfit);
                };

                function setNumericInputFilter(inputElement) {
                    inputElement.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^0-9.,]/g, '').replace(/,/g, '.');
                        const parts = value.split('.');
                        if (parts.length > 2) value = parts[0] + '.' + parts.slice(1).join('');
                        e.target.value = value;
                        if (!inputElement.classList.contains('atelier-input')) calculateAll();
                    });
                }
                
                document.querySelectorAll('.numeric-input').forEach(setNumericInputFilter);
                
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) node.querySelectorAll('.numeric-input').forEach(setNumericInputFilter);
                        });
                    });
                });

                observer.observe(materialsContainer, { childList: true });
                observer.observe(tasksContainer, { childList: true });
                
                document.querySelectorAll('.atelier-input').forEach(input => {
                    input.addEventListener('input', calculateAll);
                });

                const generateDescriptionBtn = document.getElementById('generateDescription');
                const generateSuggestionsBtn = document.getElementById('generateSuggestions');
                const descriptionLoader = document.getElementById('descriptionLoader');
                const descriptionResult = document.getElementById('descriptionResult');
                const suggestionsLoader = document.getElementById('suggestionsLoader');
                const suggestionsResult = document.getElementById('suggestionsResult');

                generateDescriptionBtn.addEventListener('click', async () => {
                    const pieceName = document.getElementById('pieceName').value || "uma peça de artesanato";
                    const materials = Array.from(document.querySelectorAll('.material-name')).map(input => input.value).filter(Boolean);
                    const finalPrice = document.getElementById('finalPrice').textContent;
                    if (materials.length === 0) { descriptionResult.textContent = "Adicione pelo menos um material."; return; }
                    const dataPayload = { type: 'description', pieceName, materials, finalPrice };
                    descriptionLoader.classList.remove('hidden');
                    descriptionResult.textContent = '';
                    descriptionResult.textContent = await callAIAssistant(dataPayload);
                    descriptionLoader.classList.add('hidden');
                });

                generateSuggestionsBtn.addEventListener('click', async () => {
                    const pieceName = document.getElementById('pieceName').value || "uma peça de artesanato";
                    const materials = Array.from(document.querySelectorAll('.material-name')).map(input => input.value).filter(Boolean);
                    const totalTime = document.getElementById('totalTime').textContent;
                    const finalPrice = document.getElementById('finalPrice').textContent;
                    if (materials.length === 0) { suggestionsResult.textContent = "Adicione os detalhes da peça."; return; }
                    const dataPayload = { type: 'suggestions', pieceName, materials, totalTime, finalPrice };
                    suggestionsLoader.classList.remove('hidden');
                    suggestionsResult.textContent = '';
                    suggestionsResult.textContent = await callAIAssistant(dataPayload);
                    suggestionsLoader.classList.add('hidden');
                });
                
                const pieceInputs = document.querySelectorAll('.piece-input');
                const restoreBanner = document.getElementById('restoreBanner');

                function savePieceToLocalStorage() {
                    const materials = Array.from(document.querySelectorAll('.material-row')).map(row => ({ name: row.querySelector('.material-name').value, price: row.querySelector('.material-price').value, quantity: row.querySelector('.material-quantity').value }));
                    const tasks = Array.from(document.querySelectorAll('.task-row')).map(row => ({ name: row.querySelector('.task-name').value, time: row.querySelector('.task-time').value }));
                    const data = { pieceName: document.getElementById('pieceName').value, profitMargin: document.getElementById('profitMargin').value, fees: document.getElementById('fees').value, materials, tasks };
                    localStorage.setItem('unsavedPiece', JSON.stringify(data));
                }

                window.checkAndRestorePiece = function() {
                    const savedData = localStorage.getItem('unsavedPiece');
                    if (savedData) {
                        restoreBanner.classList.remove('hidden');
                    } else {
                        materialsContainer.innerHTML = '';
                        tasksContainer.innerHTML = '';
                        addMaterialRow();
                        addTaskRow();
                    }
                }

                document.getElementById('restoreYes').addEventListener('click', () => {
                    const savedData = JSON.parse(localStorage.getItem('unsavedPiece'));
                    if (savedData) {
                        document.getElementById('pieceName').value = savedData.pieceName;
                        document.getElementById('profitMargin').value = savedData.profitMargin;
                        document.getElementById('fees').value = savedData.fees;
                        materialsContainer.innerHTML = '';
                        tasksContainer.innerHTML = '';
                        savedData.materials.forEach(m => addMaterialRow(m.name, m.price, m.quantity));
                        savedData.tasks.forEach(t => addTaskRow(t.name, t.time));
                        calculateAll();
                    }
                    localStorage.removeItem('unsavedPiece');
                    restoreBanner.classList.add('hidden');
                });
                
                document.getElementById('restoreNo').addEventListener('click', () => {
                    localStorage.removeItem('unsavedPiece');
                    restoreBanner.classList.add('hidden');
                    materialsContainer.innerHTML = '';
                    tasksContainer.innerHTML = '';
                    addMaterialRow();
                    addTaskRow();
                });

                document.body.addEventListener('input', (e) => {
                    if (e.target.matches('.piece-input')) {
                        savePieceToLocalStorage();
                    }
                });
                
                // --- Lógica de Navegação SPA ---
                const navLinks = document.querySelectorAll('.nav-link');
                const views = {
                    dashboard: document.getElementById('dashboardView'),
                    calculator: document.getElementById('calculatorView'),
                    'my-pieces': document.getElementById('myPiecesView'),
                    management: document.getElementById('managementView'),
                    stock: document.getElementById('stockView')
                };

                function navigate(hash) {
                    const targetView = hash.substring(1); // remove #
                    
                    navLinks.forEach(link => {
                        if (link.hash === hash) {
                            link.classList.add('bg-brand-primary/20');
                        } else {
                            link.classList.remove('bg-brand-primary/20');
                        }
                    });

                    Object.keys(views).forEach(key => {
                        if (key === targetView) {
                            views[key].classList.remove('hidden');
                        } else {
                            views[key].classList.add('hidden');
                        }
                    });
                }

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const hash = e.currentTarget.hash;
                        if(e.currentTarget.classList.contains('cursor-not-allowed')) return;
                        navigate(hash);
                    });
                });
                
                // --- Lógica da Barra Lateral ---
                const sidebar = document.getElementById('sidebar');
                const sidebarToggle = document.getElementById('sidebar-toggle');
                const sidebarOverlay = document.getElementById('sidebar-overlay');

                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('-translate-x-full');
                    sidebarOverlay.classList.toggle('hidden');
                });
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                });
                
                // Navegação inicial
                navigate('#dashboard');
            }

            setupCalculator();
        }

        main();
    </script>
</body>
</html>
