<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Arttes da Bel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-bg': '#F3E4D7',
                        'brand-text': '#786D4E',
                        'brand-olive': '#A5A184',
                        'brand-pink': '#F39B92',
                        'brand-primary': '#DA7E55',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Montserrat', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; font-family: 'Inter', sans-serif; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #DA7E55; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .input-prefix { position: absolute; left: 0; top: 0; height: 100%; display: flex; align-items: center; padding-left: 0.75rem; color: #6b7280; }
        .input-group input { padding-left: 2.5rem; }
        .saved-status { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-brand-bg/50 text-brand-text">

    <div id="loginView">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-md">
                <header class="text-center mb-8">
                    <img src="https://raw.githubusercontent.com/Rodreitz/sites/adab42e1b226613b95b484f00337e8c1903b186b/LOGO%20COM%20NOME%20transparente.png" alt="Logo Arttes da Bel" class="mx-auto w-48 h-auto mb-4">
                    <h1 class="font-display text-3xl text-brand-primary">Área Exclusiva</h1>
                    <p class="text-brand-text">Acesse a calculadora e outras ferramentas.</p>
                </header>
                <main class="bg-white p-8 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <form id="authForm" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-brand-text">Email</label>
                            <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-brand-text">Senha</label>
                            <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                        </div>
                        <div id="errorMessage" class="hidden p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
                        <div class="flex flex-col gap-4">
                            <button type="submit" id="loginButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-white bg-brand-primary hover:bg-brand-text focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary font-semibold">Entrar</button>
                            <button type="submit" id="registerButton" class="w-full flex justify-center py-2 px-4 border border-brand-olive text-brand-text bg-transparent hover:bg-brand-bg rounded-md shadow-sm font-semibold">Cadastrar</button>
                        </div>
                    </form>
                </main>
                <footer class="text-center mt-8 text-sm text-gray-500">
                    <p>&copy; 2024 - Arttes da Bel</p>
                </footer>
            </div>
        </div>
    </div>

    <div id="calculatorView" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <header class="text-center mb-12">
                <div class="flex justify-center items-center gap-4 sm:gap-6 relative">
                    <img src="https://raw.githubusercontent.com/Rodreitz/sites/adab42e1b226613b95b484f00337e8c1903b186b/LOGO%20COM%20NOME%20transparente.png" alt="Logo Arttes da Bel" class="w-24 h-auto">
                    <div class="text-left">
                        <h1 class="font-display text-3xl sm:text-4xl md:text-5xl text-brand-primary">Calculadora F.L.O.R.A.</h1>
                        <p class="text-md sm:text-lg text-brand-text mt-1">Uma ferramenta da Arttes da Bel</p>
                    </div>
                    <button id="logoutButton" class="absolute top-0 right-0 mt-2 mr-2 text-sm bg-brand-pink text-white font-semibold py-1 px-3 rounded-full hover:bg-brand-primary transition-colors">Sair</button>
                </div>
            </header>
            <main class="space-y-8">
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-display text-2xl text-brand-text flex items-center">
                            <span class="text-3xl mr-3">1.</span> Dados do Seu Ateliê 
                        </h2>
                        <span id="atelierDataStatus" class="saved-status text-sm font-medium text-brand-olive opacity-0">Salvo!</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label for="hourlyRate" class="block text-sm font-medium text-brand-text">Valor da sua Hora de Trabalho</label>
                            <div class="relative mt-1 input-group">
                                <span class="input-prefix">R$</span>
                                <input type="text" inputmode="decimal" id="hourlyRate" class="atelier-input numeric-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="20.00">
                            </div>
                        </div>
                        <div>
                            <label for="fixedCosts" class="block text-sm font-medium text-brand-text">Custos Fixos Mensais</label>
                            <div class="relative mt-1 input-group">
                                 <span class="input-prefix">R$</span>
                                <input type="text" inputmode="decimal" id="fixedCosts" class="atelier-input numeric-input w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="300.00">
                            </div>
                        </div>
                        <div>
                            <label for="hoursWorked" class="block text-sm font-medium text-brand-text">Horas Trabalhadas por Mês</label>
                            <input type="text" inputmode="decimal" id="hoursWorked" class="atelier-input numeric-input w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="80">
                        </div>
                    </div>
                     <div class="mt-4 bg-brand-bg p-3 rounded-lg text-center">
                        <p class="text-sm text-brand-text">Custo Fixo por Hora do Ateliê:</p>
                        <p id="fixedCostPerHour" class="text-lg font-bold text-brand-text">R$ 0,00</p>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                        <span class="text-3xl mr-3">2.</span> Custos da Peça
                    </h2>
                    <div>
                        <label for="pieceName" class="block text-sm font-medium text-brand-text">Nome da Peça (Ex: Jogo Americano Floral)</label>
                        <input type="text" id="pieceName" class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="Jogo Americano Floral">
                    </div>
                    <h3 class="font-display text-lg font-semibold text-brand-text mt-6 mb-2">A. Custo dos Materiais</h3>
                    <div id="materialsContainer" class="space-y-4"></div>
                    <button id="addMaterial" class="mt-4 text-sm text-brand-primary hover:text-brand-text font-medium">+ Adicionar Material</button>
                    <div class="mt-4 text-right bg-gray-50 p-2 rounded-md">
                        <span class="font-medium text-gray-600">Subtotal de Materiais:</span>
                        <span id="materialsSubtotal" class="font-bold text-gray-800 ml-2">R$ 0,00</span>
                    </div>
                    <h3 class="font-display text-lg font-semibold text-brand-text mt-6 mb-2">B. Custo da Mão de Obra</h3>
                    <div id="tasksContainer" class="space-y-4"></div>
                    <button id="addTask" class="mt-4 text-sm text-brand-primary hover:text-brand-text font-medium">+ Adicionar Tarefa</button>
                    <div class="mt-4 text-right bg-gray-50 p-2 rounded-md">
                        <span class="font-medium text-gray-600">Tempo Total de Produção:</span>
                        <span id="totalTime" class="font-bold text-gray-800 ml-2">0 min</span>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                       <span class="text-3xl mr-3">3.</span> Resumo dos Custos
                    </h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                            <span class="font-medium text-gray-600">Custo Total de Materiais</span>
                            <span id="summaryMaterials" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                            <span class="font-medium text-gray-600">Custo Total da Mão de Obra</span>
                            <span id="summaryLabor" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                            <span class="font-medium text-gray-600">Custo Fixo da Peça</span>
                            <span id="summaryFixed" class="font-bold text-lg text-gray-800">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center bg-brand-olive/20 p-4 rounded-lg mt-2">
                            <span class="font-bold text-brand-text text-lg">CUSTO DE PRODUÇÃO DA PEÇA</span>
                            <span id="productionCost" class="font-extrabold text-2xl text-brand-text">R$ 0,00</span>
                        </div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                        <span class="text-3xl mr-3">4.</span> Preço Final de Venda
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                        <div>
                            <label for="profitMargin" class="block text-sm font-medium text-brand-text">Sua Margem de Lucro (%)</label>
                            <input type="text" inputmode="decimal" id="profitMargin" class="numeric-input w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="100">
                        </div>
                        <div>
                            <label for="fees" class="block text-sm font-medium text-brand-text">Taxas (Cartão, Marketplace, etc. em %)</label>
                            <input type="text" inputmode="decimal" id="fees" class="numeric-input w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" placeholder="5">
                        </div>
                    </div>
                    <div class="mt-6 space-y-4">
                        <div class="bg-brand-primary text-white p-6 rounded-2xl text-center">
                            <p class="font-semibold text-lg opacity-90">PREÇO DE VENDA FINAL (SUGERIDO)</p>
                            <p id="finalPrice" class="font-extrabold text-5xl tracking-tight">R$ 0,00</p>
                        </div>
                        <div class="bg-brand-pink/30 border-l-4 border-brand-pink text-brand-text p-4 rounded-r-lg">
                            <div class="flex justify-between items-center">
                                <p class="font-bold text-lg">LUCRO LÍQUIDO POR PEÇA:</p>
                                <p id="netProfit" class="font-bold text-2xl">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="bg-white p-6 rounded-2xl shadow-lg shadow-brand-olive/20">
                    <h2 class="font-display text-2xl text-brand-text mb-4 flex items-center">
                       <span class="text-3xl mr-3">5.</span> Assistente de Vendas IA ✨
                    </h2>
                    <p class="text-gray-600 mb-6">Use a inteligência artificial para criar textos de venda e ter ideias para divulgar seu produto. Preencha os dados da peça acima e clique nos botões abaixo.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-display text-lg font-semibold text-brand-text">Descrição Mágica para Redes Sociais</h3>
                            <button id="generateDescription" class="w-full mt-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                Gerar Descrição
                            </button>
                            <div id="descriptionLoader" class="loader hidden"></div>
                            <div id="descriptionResult" class="mt-4 p-4 bg-gray-50 rounded-md text-gray-700 whitespace-pre-wrap min-h-[100px] border"></div>
                        </div>
                        <div>
                            <h3 class="font-display text-lg font-semibold text-brand-text">Ideias Criativas para Vender Mais</h3>
                            <button id="generateSuggestions" class="w-full mt-2 bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-text transition-colors flex items-center justify-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4.95 16.464l.707-.707a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414zm-3.536-2.121a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1z" clip-rule="evenodd" /></svg>
                                Gerar Ideias
                            </button>
                            <div id="suggestionsLoader" class="loader hidden"></div>
                            <div id="suggestionsResult" class="mt-4 p-4 bg-gray-50 rounded-md text-gray-700 whitespace-pre-wrap min-h-[100px] border"></div>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-12 text-sm text-gray-500">
                <p>&copy; 2024 - Arttes da Bel</p>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Função para buscar a configuração do Firebase do backend
        async function getFirebaseConfig() {
            try {
                const response = await fetch('/api/get-firebase-config');
                if (!response.ok) throw new Error('Falha ao buscar configuração do Firebase.');
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function main() {
            const loginView = document.getElementById('loginView');
            const calculatorView = document.getElementById('calculatorView');
            const errorMessageDiv = document.getElementById('errorMessage');

            const firebaseConfig = await getFirebaseConfig();
            if (!firebaseConfig) {
                errorMessageDiv.textContent = 'Erro de configuração. Não foi possível carregar a página.';
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- Lógica de Autenticação e Troca de Tela ---
            const loginButton = document.getElementById('loginButton');
            const registerButton = document.getElementById('registerButton');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const logoutButton = document.getElementById('logoutButton');
            
            let currentUser = null;
            let atelierDataRef = null;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    atelierDataRef = doc(db, "atelierData", currentUser.uid);
                    loginView.classList.add('hidden');
                    calculatorView.classList.remove('hidden');
                    loadAtelierData();
                } else {
                    currentUser = null;
                    atelierDataRef = null;
                    loginView.classList.remove('hidden');
                    calculatorView.classList.add('hidden');
                }
            });

            function showAuthError(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.classList.remove('hidden');
            }

            loginButton.addEventListener('click', (e) => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                    .catch((error) => {
                        showAuthError(error.code === 'auth/invalid-credential' ? "Email ou senha inválidos." : "Ocorreu um erro ao entrar.");
                    });
            });

            registerButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (passwordInput.value.length < 6) {
                    showAuthError("A senha deve ter pelo menos 6 caracteres.");
                    return;
                }
                createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                    .then(() => alert("Cadastro realizado com sucesso!"))
                    .catch((error) => {
                        showAuthError(error.code === 'auth/email-already-in-use' ? "Este email já está cadastrado." : "Ocorreu um erro ao cadastrar.");
                    });
            });
            
            logoutButton.addEventListener('click', () => {
                signOut(auth).catch((error) => console.error("Erro ao sair:", error));
            });

            // --- Lógica da Calculadora ---
            const atelierInputs = document.querySelectorAll('.atelier-input');
            const statusIndicator = document.getElementById('atelierDataStatus');
            let saveTimeout = null;

            async function loadAtelierData() {
                if (!atelierDataRef) return;
                try {
                    const docSnap = await getDoc(atelierDataRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('hourlyRate').value = data.hourlyRate || '';
                        document.getElementById('fixedCosts').value = data.fixedCosts || '';
                        document.getElementById('hoursWorked').value = data.hoursWorked || '';
                        calculateAll();
                    }
                } catch (error) {
                    console.error("Erro ao carregar dados do ateliê:", error);
                }
            }

            function saveAtelierData() {
                if (!atelierDataRef) return;
                const data = {
                    hourlyRate: document.getElementById('hourlyRate').value,
                    fixedCosts: document.getElementById('fixedCosts').value,
                    hoursWorked: document.getElementById('hoursWorked').value,
                };
                setDoc(atelierDataRef, data, { merge: true })
                    .then(() => {
                        statusIndicator.textContent = 'Salvo!';
                        statusIndicator.classList.remove('text-red-500');
                        statusIndicator.classList.add('text-brand-olive');
                        statusIndicator.style.opacity = '1';
                        setTimeout(() => { statusIndicator.style.opacity = '0'; }, 2000);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar dados:", error);
                        statusIndicator.textContent = 'Erro!';
                        statusIndicator.classList.add('text-red-500');
                        statusIndicator.style.opacity = '1';
                    });
            }
            
            atelierInputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    statusIndicator.textContent = 'Salvando...';
                    statusIndicator.style.opacity = '1';
                    saveTimeout = setTimeout(saveAtelierData, 1500);
                });
            });

            // Resto da lógica da calculadora...
            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            const callAIAssistant = async (dataPayload) => {
                const proxyUrl = '/api/gemini-proxy';
                try {
                    const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataPayload) });
                    if (!response.ok) throw new Error(`Erro na chamada do assistente: ${response.statusText}`);
                    const result = await response.json();
                    return result.text;
                } catch (error) {
                    console.error("Erro ao chamar o assistente IA:", error);
                    return "Desculpe, não foi possível gerar a resposta no momento.";
                }
            };
            
            function setupCalculator() {
                const materialsContainer = document.getElementById('materialsContainer');
                const tasksContainer = document.getElementById('tasksContainer');
                const addMaterialBtn = document.getElementById('addMaterial');
                const addTaskBtn = document.getElementById('addTask');

                const addMaterialRow = () => {
                    const div = document.createElement('div');
                    div.classList.add('relative', 'p-4', 'border', 'rounded-lg', 'space-y-2', 'pt-8', 'material-row');
                    div.innerHTML = `
                        <button class="remove-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        <div class="w-full"> <label class="text-sm font-medium text-brand-text">Nome do Material</label> <input type="text" placeholder="Ex: Tecido Tricoline" class="material-name w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div> <label class="text-sm font-medium text-brand-text">Preço</label> <div class="relative mt-1 input-group"> <span class="input-prefix text-sm">R$</span> <input type="text" inputmode="decimal" placeholder="30.00" class="numeric-input material-price w-full p-2 border border-gray-200 rounded-md text-sm"> </div> </div>
                            <div> <label class="text-sm font-medium text-brand-text">Qtd. Usada</label> <input type="text" inputmode="decimal" placeholder="0.45" class="numeric-input material-quantity w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        </div>`;
                    materialsContainer.appendChild(div);
                    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); calculateAll(); });
                };

                const addTaskRow = () => {
                    const div = document.createElement('div');
                    div.classList.add('relative', 'p-4', 'border', 'rounded-lg', 'space-y-2', 'pt-8', 'task-row');
                    div.innerHTML = `
                        <button class="remove-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        <div class="w-full"> <label class="text-sm font-medium text-brand-text">Nome da Tarefa</label> <input type="text" placeholder="Ex: Cortar e Costurar" class="w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>
                        <div> <label class="text-sm font-medium text-brand-text">Tempo (minutos)</label> <input type="text" inputmode="decimal" placeholder="40" class="numeric-input task-time w-full p-2 mt-1 border border-gray-200 rounded-md text-sm"> </div>`;
                    tasksContainer.appendChild(div);
                    div.querySelector('.remove-btn').addEventListener('click', () => { div.remove(); calculateAll(); });
                };

                addMaterialRow();
                addTaskRow();

                addMaterialBtn.addEventListener('click', addMaterialRow);
                addTaskBtn.addEventListener('click', addTaskRow);

                const calculateAll = () => {
                    const hourlyRate = parseFloat(document.getElementById('hourlyRate').value.replace(',', '.')) || 0;
                    const fixedCosts = parseFloat(document.getElementById('fixedCosts').value.replace(',', '.')) || 0;
                    const hoursWorked = parseFloat(document.getElementById('hoursWorked').value.replace(',', '.')) || 0;
                    const fixedCostPerHour = hoursWorked > 0 ? fixedCosts / hoursWorked : 0;
                    document.getElementById('fixedCostPerHour').textContent = formatCurrency(fixedCostPerHour);

                    let materialsSubtotal = 0;
                    document.querySelectorAll('.material-row').forEach(row => {
                        const price = parseFloat(row.querySelector('.material-price').value.replace(',', '.')) || 0;
                        const quantity = parseFloat(row.querySelector('.material-quantity').value.replace(',', '.')) || 0;
                        materialsSubtotal += price * quantity;
                    });
                    document.getElementById('materialsSubtotal').textContent = formatCurrency(materialsSubtotal);

                    let totalMinutes = 0;
                    document.querySelectorAll('.task-row').forEach(row => {
                        totalMinutes += parseFloat(row.querySelector('.task-time').value.replace(',', '.')) || 0;
                    });
                    const totalHours = totalMinutes / 60;
                    document.getElementById('totalTime').textContent = `${Math.round(totalMinutes)} min`;
                    const laborCost = totalHours * hourlyRate;

                    const pieceFixedCost = totalHours * fixedCostPerHour;
                    const productionCost = materialsSubtotal + laborCost + pieceFixedCost;
                    document.getElementById('summaryMaterials').textContent = formatCurrency(materialsSubtotal);
                    document.getElementById('summaryLabor').textContent = formatCurrency(laborCost);
                    document.getElementById('summaryFixed').textContent = formatCurrency(pieceFixedCost);
                    document.getElementById('productionCost').textContent = formatCurrency(productionCost);

                    const profitMargin = parseFloat(document.getElementById('profitMargin').value.replace(',', '.')) || 0;
                    const fees = parseFloat(document.getElementById('fees').value.replace(',', '.')) || 0;
                    
                    const basePrice = productionCost * (1 + profitMargin / 100);
                    const finalPrice = fees > 0 && fees < 100 ? basePrice / (1 - fees / 100) : basePrice;
                    const feeValue = finalPrice * (fees / 100);
                    const netProfit = finalPrice - feeValue - productionCost;

                    document.getElementById('finalPrice').textContent = formatCurrency(finalPrice);
                    document.getElementById('netProfit').textContent = formatCurrency(netProfit);
                };

                function setNumericInputFilter(inputElement) {
                    inputElement.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^0-9.,]/g, '').replace(/,/g, '.');
                        const parts = value.split('.');
                        if (parts.length > 2) value = parts[0] + '.' + parts.slice(1).join('');
                        e.target.value = value;
                        if (!inputElement.classList.contains('atelier-input')) calculateAll();
                    });
                }
                
                document.querySelectorAll('.numeric-input').forEach(setNumericInputFilter);
                
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === 1) node.querySelectorAll('.numeric-input').forEach(setNumericInputFilter);
                        });
                    });
                });

                observer.observe(materialsContainer, { childList: true });
                observer.observe(tasksContainer, { childList: true });

                calculateAll();
                
                const generateDescriptionBtn = document.getElementById('generateDescription');
                const generateSuggestionsBtn = document.getElementById('generateSuggestions');
                const descriptionLoader = document.getElementById('descriptionLoader');
                const descriptionResult = document.getElementById('descriptionResult');
                const suggestionsLoader = document.getElementById('suggestionsLoader');
                const suggestionsResult = document.getElementById('suggestionsResult');

                generateDescriptionBtn.addEventListener('click', async () => {
                    const pieceName = document.getElementById('pieceName').value || "uma peça de artesanato";
                    const materials = Array.from(document.querySelectorAll('.material-name')).map(input => input.value).filter(Boolean);
                    const finalPrice = document.getElementById('finalPrice').textContent;
                    if (materials.length === 0) { descriptionResult.textContent = "Adicione pelo menos um material."; return; }
                    const dataPayload = { type: 'description', pieceName, materials, finalPrice };
                    descriptionLoader.classList.remove('hidden');
                    descriptionResult.textContent = '';
                    descriptionResult.textContent = await callAIAssistant(dataPayload);
                    descriptionLoader.classList.add('hidden');
                });

                generateSuggestionsBtn.addEventListener('click', async () => {
                    const pieceName = document.getElementById('pieceName').value || "uma peça de artesanato";
                    const materials = Array.from(document.querySelectorAll('.material-name')).map(input => input.value).filter(Boolean);
                    const totalTime = document.getElementById('totalTime').textContent;
                    const finalPrice = document.getElementById('finalPrice').textContent;
                    if (materials.length === 0) { suggestionsResult.textContent = "Adicione os detalhes da peça."; return; }
                    const dataPayload = { type: 'suggestions', pieceName, materials, totalTime, finalPrice };
                    suggestionsLoader.classList.remove('hidden');
                    suggestionsResult.textContent = '';
                    suggestionsResult.textContent = await callAIAssistant(dataPayload);
                    suggestionsLoader.classList.add('hidden');
                });
            }

            setupCalculator();
        }

        main();
    </script>
</body>
</html>
